# Тестовое задание ООО "Муниципальные решения"
## Основные положения
В качестве тестового задания предлагается реализация ТЗ на доработку приложения начального уровня разработки, реализующего функционал некой геоинформационной социальной сети.

Что проверяется:
- Базовый уровень навыков web-разработки
- Умение разбираться в чужом коде
- Умение в разумные сроки разбираться в новых технологиях и компонентах
- Владение основами СУБД и SQL
- Качество и понятность кода
- Умение грамотно структурировать код: выделять по необходимости логически связанный код в новый модуль и структурирование кода внутри модулей
- Время реализации поставленной задачи

Используемые технологии и компоненты:
- Система контроля версий: [Git](https://git-scm.com)
- Базовая платформа: [node.js](https://nodejs.org)
- Фреймворк [sails.js](http://sailsjs.org)
- СУБД [PostgreSQL](http://www.postgresql.org)
- Базовые стили и компоненты: [Bootstrap](http://getbootstrap.com)
- JavaScript на стороне клиента: [iQuery](https://jquery.com)
- Загрузка файлов: [plupload](http://www.plupload.com)
- Работа с картами: [Leaflet](http://leafletjs.com)
- web-шаблоны: [Jade](http://jade-lang.com)
- Полезные функции для использования на стороне сервера: [Lodash](https://lodash.com)

## Создание рабочего окружения
1. Установить последнюю стабильную версию [node.js](https://nodejs.org) (Если Вы работаете в Linux, то лучше устанавливать из исходников)
2. Установить глобально [sails.js](http://sailsjs.org)
3. Установить [git](https://git-scm.com)
4. Клонировать [этот репозиторий](https://github.com/neiromancer/cloudmaps_test) или [скачать его zip-архив](https://github.com/neiromancer/cloudmaps_test/archive/master.zip)
5. Установить локально СУБД [PostgreSQL](http://www.postgresql.org)
6. Создать в СУБД пользователя test с паролем test
7. Создать БД test с владельцем test
8. Создать структуру БД test с использованием прилагаемого дампа test.backup (см. корневой каталог проекта)
9. Перейти в каталог проекта.
10. Установить зависимые node.js- и sails.js-модули с помощью команды:

    $ npm install

11. Запустить приложение с помощью команды:  

    $ sails lift

12. Приложение доступно по URL: [http://localhost:1337](http://localhost:1337)

## Техническое задание на разработку
### Функциональные требования
1. Добавил имя и фамилию разработчика на главной странице
2. Исправил ошибку, при которой авторизация нового пользователя происходит независимо от того подтвержден email пользователя или нет.
3. Исправил искажение аватарки при отображении в списке пользователей, если исходная картинка не является квадратной. Поскольку необходимо было использовать plupload, то в качестве решения проблемы помимо аватарки загружалась ее обрезанная до 60 на 60 версия, которая в дальнейшем использовалась для картинки в списке пользователей.  
4. Создал favicon для проекта. Можно сделать и различные разрешения для иконок с использованием атрибута sizes, иконки для плиток в Windows с использованием browserconfig.xml, добавить manifest.json для Android Chrome. Для всего многообразия иконок можно воспользоваться помощником, к примеру http://realfavicongenerator.net/.
5. Для того, чтобы определить онлайн пользователь или нет, необходимо отслеживать его активность. Первым делать отслеживать его переходы по страницам ресурса. Для упрощения и централизации этого была сделана политика setOnline. Пользователь также может быть на одной странице долгое время, для этого случая необходимо раз в какое-то время пинговать сервер, говоря ему, что мы еще онлайн. При выходе необходимо фиксировать, что пользователь оффлайн. Поскольку может быть ситуация, при которой пользователь станет оффлайн, а сервер не зафиксирует это, то необходимо запускать скрипт по крону, который будет отслеживать пользователей со статусом онлайн, но последнее время активности превышает необходимое значение и выставлять их в оффлайн. Если пользователь онлайн, то в правом нижнем углу аватары или аватар списков отображается зеленый круг. При смене статуса происходит уведомление всех активных пользователей об этом событии средствами работы с web-сокетами.
6. Если пользователь online, то при просмотре его профиля другим пользователем он видет на карте место положения пользователя с маркером зеленого цвета. Если пользователь offline, то отображать на карте точку его последнего пребывания маркером красного цвета. Если не возможно установить текущее положение (пользователь отключил эту возможность), то справа вверху над картой появляется иконка серого цвета и если есть предыдущие координаты, то они отображаются на карте маркером серого цвета. При смене координат, статуса или запрета на определение координат всем друзьям рассылается уведомление об этом средствами работы с web-сокетами.
7. Сделал доступным просмотр профиля пользователя с user/\<username\> и user/\<id\>
8. Реализовал просмотр профилей друзей из списка. При попытке просмотреть профиль пользователя, не являющегося другом, путем явного указания url его профиля, выводится сообщение о невозможности просмотра данной информации. Разделил шаблоны профилей для владельца профиля и друга, унаследовав их от одного шаблона
9. Реализовал обмен сообщениями между друзьями. Под аватарой ссылка на мессенджер. Слева список друзей, содержащий последнее сообщение и количество непрочитанных сообщений в диалоге, справа переписка. Мессенджер работает без перезагрузки страницы. Происходит уведомление контакта, с котором ведется переписка средствами работы с web-сокетами. Если он в этот момент в мессенджере, то добавляется сообщение в диалог, изменяется последнее сообщение с списке контактов и счетчик непрочитанных сообщений. Если контакт находится в профиле, то увеличивается счетчик непрочитанных сообщений и всплывает нотификация в правом нижнем углу с сообщением, при нажатии на аватару которого открывается мессенджер с данным контактом, при нажатии на остальную часть - закрытие уведомления. 

### Дополнительно
1. Отправка письма для активации пользователя вынесена в отдельный сервис
2. Исправлена ошибка, которая возникала при введении незарегистрированного логина
3. Исправлена ошибка, возникающая при попытке открыть профиль несуществующего пользователя

### Предложения
1. В письме, отвечающем за активацию аккаунта использовать токен, который не содержит в себе пароль ни в каком виде. Ссылка остается в письме, в истории браузера, а базы хешей в интернете достаточно активно пополняются.
2. Быть может лучше передавать средствами plupload оригинальное изображение, отресайзенное до разумных пределов, а обрезание делать на сервере, скажем sails-service-image и предоставить пользователю возможность самому выбирать область обрезания исходного изображения.

### Нефункциональные требования
1. После реализации каждого пункта функциональных требований необходимо делать коммит с соответствующим комментарием.
2. В конце работы сделать дамп Вашей тестовой БД в файл test.backup в корне проекта (заменить существующий) и сделать коммит с соответсвующим коментарием. Формат дампа должен быть таким, чтобы его можно было загрузить с помощью команды pg_restore
3. Создать аккаунт на [Github](https://github.com), если его еще нет.
4. Создать на github пустой репозиторий для Вашего тестового проекта.
5. Разместить Ваш локальный репозитарий тестового проекта в github.
6. Описание Вашего тестового задания на github (файл README.md) замените своим с кратким описанием того, что сделано и Вашим видением того, что можно было бы добавить в плане функциональности в данный проект.
7. Если в процессе анализа кода Вы увидели возможности его оптимизации, то сделайте это и обязательно отразите, что и как Вы оптимизировали в кратком описании к проекту (см. п.6).
8. Дизайн разработки определяется возможностями [Bootstrap](http://getbootstrap.com) и фантазией разработчика

### Дополнительные подсказки
- Последовательность реализации функциональных требований не имеет значения. Вероятнее всего, что за предоставленное время все требования реализовать не удастся. Чем больше получится реализовать, тем лучше. При этом будет учитываться даже начальная (не полная) реализация требования.
- При отладке активации пользователя через email удобно пользоваться примитивным локальным smtp-сервером. специально предназначенным для этих целей. Для разработчиков, работающих в среде Windows это может быть например [Papercut](https://papercut.codeplex.com). Для тех же, кто работает в среде Linux или Mac можно либо настроить свой локальный smtp-сервер, либо использовать, следующий, который запускается командой:  

    sudo python -m smtpd -n -c DebuggingServer localhost:25

- Естественно, что структура БД может менятся на усмотрение разработчика в соответствии с необходимостью, возникающей при реализации функциональных требований.
- В качестве решения тестового задания необходимо отправить на электронный адрес, с которого Вы получили задание, URL проекта на github.
- Если в процессе работы возникают дополнительные вопросы, ответов на которые нет в данном описании, то разработчик должен сам принять решение по возникшему вопросу.
